'use strict';

var url = require('url');
var $ = require('jquery');
var sprintf = require('sprintf');

angular.module('tangHelper.minerService', ['ng'])
    .config(function($httpProvider) {
        $httpProvider.defaults.transformRequest.unshift(
            function(data, headers) {
                if (angular.isObject(data)) {
                    headers()['Content-Type'] =
                        'application/x-www-form-urlencoded; charset=utf-8';
                    return $.param(data);
                }
                return data;
            });
    })
    .factory('operate', function($http, $q, $timeout,
                                 formatUserName, multipartTransform,
                                 getBroadcastAddr) {

        function getPoolUrl(url, port) {
            if (url === null && port === null) {
                return '';
            }
            return sprintf('stratum+tcp://%s:%s', url, port);
        }

        return function(minerConfig) {
            var baseUrlObject = {
                protocol: 'http',
                host: minerConfig.minerDefaultAddress
            };

            var stok;

            //登录
            return $http.post(url.format(angular.extend({}, baseUrlObject, {
                pathname: '/cgi-bin/luci'
            })), {
                username: 'root',
                password: 'root'
            }).then(function(response) {
                /* jshint -W101 */
                var re = /href="(\/cgi-bin\/luci\/;stok=(.+?)\/admin\/status\/minerstatus\/)">Miner Status/;
                /* jshint +W101 */
                var matchResult = response.data.match(re);
                if (matchResult === null) {
                    return $q.reject('没有找到 URL 和 stok.');
                }
                stok = matchResult[2];
            //修改配置
            }).then(function() {
                var username = formatUserName(
                    minerConfig.username,
                    minerConfig.prefix,
                    minerConfig.IP
                );
                var data = {
                    'cbi.submit': '1',

                    'cbid.cgminer.default.pool1url': getPoolUrl(
                        minerConfig.pool1URL, minerConfig.pool1Port),
                    'cbid.cgminer.default.pool1user': username,
                    'cbid.cgminer.default.pool1pw': '123',

                    'cbid.cgminer.default.pool_balance': '  ',
                    'cbid.cgminer.default.bitmain_nobeeper':
                        '--bitmain-nobeeper',
                    'cbid.cgminer.default.bitmain_notempoverctrl': '  ',
                    'cbid.cgminer.default.freq': '17:237.5:1286',
                    'cbi.apply': 'Save'
                };

                if (minerConfig.pool2URL && minerConfig.pool2Port) {
                    data['cbid.cgminer.default.pool2url'] =
                        getPoolUrl(minerConfig.pool2URL, minerConfig.pool2Port);
                    data['cbid.cgminer.default.pool2user'] = username;
                    data['cbid.cgminer.default.pool2pw'] = '123';
                }
                if (minerConfig.pool3URL && minerConfig.pool3Port) {
                    data['cbid.cgminer.default.pool3url'] =
                        getPoolUrl(minerConfig.pool3URL, minerConfig.pool3Port);
                    data['cbid.cgminer.default.pool3user'] = username;
                    data['cbid.cgminer.default.pool3pw'] = '123';
                }

                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/status/miner/')
                }));

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //重启 cgminer 进程
            }).then(function() {
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/servicectl/restart/cgminer')
                }));
                return $http.get(urlString);
            //修改服务设置
            }).then(function() {
                var data = {
                    'cbi.submit': '1',
                    'cbid.table.60.dnsmasq.endisable': 'Enabled'
                };
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/system/startup')
                }));

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //关闭服务
            }).then(function() {
                var data = {
                    'cbi.submit': '1',
                    'cbid.table.60.dnsmasq.stop': 'Stop'
                };
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/system/startup')
                }));

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //修改网络配置
            }).then(function() {
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/network/network/wan')
                }));

                var data = {
                    'cbi.submit': '1',
                    'tab.network.wan': 'general',
                    'cbid.network.wan._fwzone': 'lan',
                    'cbid.network.wan._fwzone.newzone': '',
                    'cbi.cbe.network.wan.type': '1',
                    'cbi.cbe.network.wan.ifname_single': '1',
                    'cbid.network.wan.ifname_single': 'eth1',
                    'cbid.network.wan.proto': 'static',
                    'cbid.network.wan.ipaddr': minerConfig.IP,
                    'cbid.network.wan.netmask': minerConfig.mask,
                    'cbid.network.wan.gateway': minerConfig.gateway,
                    'cbid.network.wan.broadcast':
                        getBroadcastAddr('255.255.255.0', minerConfig.IP),
                    'cbid.network.wan.dns': minerConfig.dns1,
                    '__cbid.network.wan.dns': '8.8.8.8',    //duplicate property
                    'cbi.cbe.network.wan.auto': '1',
                    'cbid.network.wan.auto': '1',
                    'cbid.network.wan.macaddr': '',
                    'cbid.network.wan.mtu': '',
                    'cbid.network.wan.metric': '',
                    'tab.dhcp.wan': 'general',
                    'cbi.cbe.dhcp.wan.ignore': '1',
                    'cbid.dhcp.wan.ignore': '1',
                    'cbi.apply': 'Save & Apply'
                };

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //使配置生效
            }).then(function() {
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok,
                        '/servicectl/restart/network,wireless,firewall,dhcp')
                }));
                return $http.get(urlString);
            });
        };
    });