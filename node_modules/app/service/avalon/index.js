'use strict';

var url = require('url');
var $ = require('jquery');
var sprintf = require('sprintf');

angular.module('tangHelper.minerService', ['ng'])
    .config(function($httpProvider) {
        $httpProvider.defaults.transformRequest.unshift(
            function(data, headers) {
                if (angular.isObject(data)) {
                    headers()['Content-Type'] =
                        'application/x-www-form-urlencoded; charset=utf-8';
                    return $.param(data);
                }
                return data;
            });
    })
    .factory('operate', function($http, $q, $timeout,
                                 formatUserName, multipartTransform) {

        function getPoolUrl(url, port) {
            if (url === null && port === null) {
                return '';
            }
            return sprintf('stratum+tcp://%s:%s', url, port);
        }

        function getBroadcastAddr(mask, IP) {
            var maskParts = mask.split('.');
            var IPParts = IP.split('.');
            return maskParts.map(function(el, k) {
                return (255 - el) | IPParts[k];
            }).join('.');
        }

        return function(minerConfig) {
            var baseUrlObject = {
                protocol: 'http',
                host: minerConfig.minerDefaultAddress
            };

            var stok;

            //登录
            return $http.post(url.format(angular.extend({}, baseUrlObject, {
                pathname: '/cgi-bin/luci'
            })), {
                username: 'root',
                password: 'root'
            }).then(function(response) {
                /* jshint -W101 */
                var re = /href="(\/cgi-bin\/luci\/;stok=(.+?)\/admin\/status\/cgminer\/)">Cgminer Configuration/;
                /* jshint +W101 */
                var matchResult = response.data.match(re);
                if (matchResult === null) {
                    return $q.reject('没有找到 URL 和 stok.');
                }
                stok = matchResult[2];
            //修改配置
            }).then(function() {
                var username = formatUserName(
                    minerConfig.username,
                    minerConfig.prefix,
                    minerConfig.IP
                );
                var data = {
                    'cbid.cgminer.default.ntp_enable': 'asia',
                    'cbi.submit': '1',

                    'cbid.cgminer.default.pool1url': getPoolUrl(
                        minerConfig.pool1URL, minerConfig.pool1Port),
                    'cbid.cgminer.default.pool1user': username,
                    'cbid.cgminer.default.pool1pw': '123',

                    'cbid.cgminer.default.pool_balance': '',
                    'cbid.cgminer.default.chip_frequency': '500',
                    'cbid.cgminer.default.chip_voltage': '7250',
                    'cbid.cgminer.default.fan': '90',
                    'cbid.cgminer.default.api_allow': 'W:127.0.0.1',
                    'cbid.cgminer.default.more_options': '--real-quiet',
                    'cbi.apply': 'Save'
                };

                if (minerConfig.pool2URL && minerConfig.pool2Port) {
                    data['cbid.cgminer.default.pool2url'] =
                        minerConfig.pool2URL;
                    data['cbid.cgminer.default.pool2pw'] = '123';
                    data['cbid.cgminer.default.pool2user'] = username;
                }
                if (minerConfig.pool3URL && minerConfig.pool3Port) {
                    data['cbid.cgminer.default.pool3url'] =
                        minerConfig.pool3URL;
                    data['cbid.cgminer.default.pool3pw'] = '123';
                    data['cbid.cgminer.default.pool3user'] = username;
                }

                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/status/cgminer')
                }));

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //修改服务设置
            }).then(function() {
                var data = {
                    'cbi.submit': '1',
                    'cbid.table.60.dnsmasq.endisable': 'Enabled'
                };
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/system/startup')
                }));

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //关闭服务
            }).then(function() {
                var data = {
                    'cbi.submit': '1',
                    'cbid.table.60.dnsmasq.stop': 'Stop'
                };
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/system/startup')
                }));

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            //修改网络配置
            }).then(function() {
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/network/network/lan')
                }));

                var data = {
                    'cbi.submit': '1',
                    'tab.network.lan': 'general',
                    'cbid.network.lan._fwzone': 'lan',
                    'cbid.network.lan._fwzone.newzone': '',
                    'cbi.cbe.network.lan.type': '1',
                    'cbid.network.lan.type': 'bridge',
                    'cbi.cbe.network.lan.stp': '1',
                    'cbi.cbe.network.lan.ifname_multi': '1',
                    'cbid.network.lan.ifname_multi': 'eth0',
                    '__cbid.network.lan.ifname_multi': 'radio0.network1',
                    'cbid.network.lan.proto': 'static',
                    'cbid.network.lan.ipaddr': minerConfig.IP,
                    'cbid.network.lan.netmask': minerConfig.mask,
                    'cbid.network.lan.gateway': minerConfig.gateway,
                    'cbid.network.lan.broadcast':
                        getBroadcastAddr('255.255.255.0', minerConfig.IP),
                    'cbid.network.lan.dns': minerConfig.dns1,
                    '__cbid.network.lan.dns': '8.8.8.8',
                    'cbi.cbe.network.lan.auto': '1',
                    'cbid.network.lan.auto': '1',
                    'cbid.network.lan.macaddr': '',
                    'cbid.network.lan.mtu': '',
                    'cbid.network.lan.metric': '',
                    'tab.dhcp.lan': 'general',
                    'cbid.dhcp.lan.ra': 'hybrid',
                    'cbid.dhcp.lan.dhcpv6': 'hybird',
                    'cbid.dhcp.lan.ndp': 'hybird',
                    'cbid.dhcp.lan.ra_management': '1',
                    'cbi.cbe.dhcp.lan.ra_default': '1',
                    'cbid.dhcp.lan.dns': '',
                    'cbid.dhcp.lan.domain': '',
                    'cbi.cbe.dhcp.lan.ignore': '1',
                    'cbid.dhcp.lan.ignore': '1',
                    'cbi.apply': 'Save & Apply'
                };

                return $http({
                    method: 'POST',
                    url: urlString,
                    data: data,
                    transformRequest: multipartTransform
                });
            }).then(function() {
                var urlString = url.format(angular.extend({}, baseUrlObject, {
                    pathname: sprintf('/cgi-bin/luci/;stok=%s%s',
                        stok, '/admin/system/reboot'),
                    search: 'reboot=1'
                }));
                return $http.get(urlString);
            });
        };
    });