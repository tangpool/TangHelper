/* jslint latedef:false */
'use strict';

angular.module('tangHelper.executorCtrl', [])
    .controller('executorCtrl', executorCtrl);

function executorCtrl($scope, $q, conf, connect, operate) {
    /* jshint validthis: true */
    console.log('config: %o', conf);
    this.conf = conf;
    var self = this;

    var status = [
        'waitingForConnecting',
        'operating',
        'waitingForDisconnecting'
    ];
    //进入等待连接状态
    this.activeStatus = status[0];

    var count = 0;
    (function loop() {
        var disconnectFn;
        connect(conf.minerDefaultAddress)
            .then(function(tryToDisconnect) {
                console.log('连接成功');
                self.activeStatus = status[1];
                disconnectFn = tryToDisconnect;

                return operate();
            })
            .then(function() {
                console.log('操作完成');
                self.activeStatus = status[2];
                return disconnectFn();
            }, function() {
                console.log('操作失败...');

                //TODO 待处理
            })
            .then(function() {
                console.log('断开完成');
                self.activeStatus = status[0];

                loop();
            });
    })();
}